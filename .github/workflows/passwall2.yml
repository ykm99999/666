name: Build PassWall2 Packages for SL-3000

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git wget curl unzip \
          libncurses5-dev libncursesw5-dev zlib1g-dev gawk flex gettext \
          libssl-dev python3 python3-distutils rsync

    - name: Clone OpenWrt SDK (filogic, aarch64_cortex-a53)
      run: |
        wget https://downloads.openwrt.org/releases/23.05.3/targets/mediatek/filogic/openwrt-sdk-23.05.3-mediatek-filogic_gcc-12.3.0_musl.Linux-x86_64.tar.xz
        tar -xf openwrt-sdk-*.tar.xz
        mv openwrt-sdk-* openwrt

    - name: Fetch PassWall2 source
      run: |
        cd openwrt/package
        git clone https://github.com/xiaorouji/openwrt-passwall2 passwall2

    - name: Build PassWall2
      run: |
        cd openwrt
        make package/passwall2/compile V=s

    - name: Upload packages
      uses: actions/upload-artifact@v3
      with:
        name: passwall2-packages
        path: openwrt/bin/packages/aarch64_cortex-a53/
