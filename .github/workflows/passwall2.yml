- name: Create package-only configuration
  working-directory: sdk
  run: |
    # 创建专门用于软件包编译的配置
    cat > .config << 'EOF'
    # ======================
    # 目标架构配置
    # ======================
    CONFIG_TARGET_ramips=y
    CONFIG_TARGET_ramips_mt7621=y
    CONFIG_TARGET_ramips_mt7621_DEVICE_xiaomi_mi-router-4a-gigabit=y

    # ======================
    # 工具链配置
    # ======================
    CONFIG_TOOLCHAIN=y
    CONFIG_TOOLCHAIN_LIBC="musl"
    CONFIG_GCC_USE_GRAPHITE=y
    CONFIG_GCC_USE_VERSION_11=y

    # ======================
    # 基础系统包（最小集）
    # ======================
    CONFIG_PACKAGE_libc=y
    CONFIG_PACKAGE_libgcc=y
    CONFIG_PACKAGE_libpthread=y
    CONFIG_PACKAGE_librt=y
    CONFIG_PACKAGE_libstdcpp=y

    # ======================
    # 核心库依赖
    # ======================
    CONFIG_PACKAGE_libopenssl=y
    CONFIG_PACKAGE_libopenssl-conf=y
    CONFIG_PACKAGE_libpcre=y
    CONFIG_PACKAGE_zlib=y
    CONFIG_PACKAGE_libuuid=y
    CONFIG_PACKAGE_libjson-c=y
    CONFIG_PACKAGE_libcurl=y
    CONFIG_PACKAGE_libevent2=y
    CONFIG_PACKAGE_libatomic=y

    # ======================
    # Golang 环境
    # ======================
    CONFIG_PACKAGE_golang=y
    CONFIG_PACKAGE_golang-src=y
    CONFIG_GOLANG_EXTERNAL_BOOTSTRAP_ROOT=""
    CONFIG_GOLANG_BUILD_CACHE_DIR="/tmp/go-build"
    CONFIG_GOLANG_MOD_CACHE_WORKAROUND=y

    # ======================
    # 网络基础库
    # ======================
    CONFIG_PACKAGE_libnetfilter-conntrack=y
    CONFIG_PACKAGE_libnfnetlink=y
    CONFIG_PACKAGE_libmnl=y
    CONFIG_PACKAGE_iptables-mod-extra=y
    CONFIG_PACKAGE_iptables-mod-tproxy=y

    # ======================
    # Luci 基础（passwall2 依赖）
    # ======================
    CONFIG_PACKAGE_luci-base=y
    CONFIG_PACKAGE_luci-compat=y
    CONFIG_PACKAGE_luci-lib-ipkg=y
    CONFIG_PACKAGE_luci-lib-nixio=y
    CONFIG_PACKAGE_luci-proto-ipv6=y
    CONFIG_PACKAGE_luci-theme-bootstrap=y

    # ======================
    # 内核模块（网络相关）
    # ======================
    CONFIG_PACKAGE_kmod-crypto-core=y
    CONFIG_PACKAGE_kmod-crypto-aead=y
    CONFIG_PACKAGE_kmod-crypto-manager=y
    CONFIG_PACKAGE_kmod-crypto-pcompress=y
    CONFIG_PACKAGE_kmod-crypto-sha1=y
    CONFIG_PACKAGE_kmod-ipt-core=y
    CONFIG_PACKAGE_kmod-ipt-extra=y
    CONFIG_PACKAGE_kmod-nf-conntrack=y
    CONFIG_PACKAGE_kmod-nf-conntrack-netlink=y
    CONFIG_PACKAGE_kmod-nf-ipt=y
    CONFIG_PACKAGE_kmod-nf-nat=y
    CONFIG_PACKAGE_kmod-nf-reject=y
    CONFIG_PACKAGE_kmod-nfnetlink=y
    CONFIG_PACKAGE_kmod-ppp=y
    CONFIG_PACKAGE_kmod-tun=y
    CONFIG_PACKAGE_kmod-ipt-tproxy=y

    # ======================
    # 系统工具
    # ======================
    CONFIG_PACKAGE_coreutils=y
    CONFIG_PACKAGE_bash=y
    CONFIG_PACKAGE_ca-bundle=y
    CONFIG_PACKAGE_ca-certificates=y
    CONFIG_PACKAGE_ip-full=y
    CONFIG_PACKAGE_resolveip=y
    CONFIG_PACKAGE_iptables=y
    CONFIG_PACKAGE_iptables-mod-conntrack-extra=y
    CONFIG_PACKAGE_iptables-mod-iprange=y
    CONFIG_PACKAGE_iptables-mod-socket=y
    CONFIG_PACKAGE_iptables-mod-tproxy=y

    # ======================
    # Passwall2 主包
    # ======================
    CONFIG_PACKAGE_luci-app-passwall2=y
    CONFIG_PACKAGE_luci-i18n-passwall2-zh-cn=y

    # ======================
    # 编译优化
    # ======================
    CONFIG_CCACHE=y
    CONFIG_BUILD_LOG=y
    CONFIG_SDK=y
    CONFIG_STRIP_ARGS="--strip-all"
    EOF

    # 应用配置
    make defconfig

    echo "=== 配置验证 ==="
    echo "目标架构: $(grep CONFIG_TARGET_ARCH .config || echo '未设置')"
    echo "启用的包数量: $(grep '^CONFIG_PACKAGE.*=y' .config | wc -l)"
