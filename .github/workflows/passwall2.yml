name: Build Passwall2 for ImmortalWrt 23.05.3 (MT7981) - Fixed

on:
  workflow_dispatch:
    inputs:
      use_mirror:
        description: 'ä½¿ç”¨ä¸­ç§‘å¤§é•œåƒ'
        required: false
        default: true
        type: boolean

env:
  TZ: Asia/Shanghai
  TERM: xterm

jobs:
  build-packages:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex g++ gawk gettext git libncurses5-dev \
            libssl-dev python3-dev python3-full python3-pip python3-setuptools \
            rsync unzip zlib1g-dev file wget curl ccache cmake ninja-build \
            libelf-dev patchelf chrpath gawk texinfo diffutils gperf

      - name: Download ImmortalWrt SDK for MT7981
        run: |
          # ä½¿ç”¨å®˜æ–¹ç¨³å®šç‰ˆ 23.05.3
          if [ "${{ inputs.use_mirror }}" = "true" ]; then
            echo "ä½¿ç”¨ä¸­ç§‘å¤§é•œåƒä¸‹è½½ 23.05.3"
            SDK_URL="https://mirrors.ustc.edu.cn/immortalwrt/releases/23.05.3/targets/mediatek/filogic/"
          else
            echo "ä½¿ç”¨å®˜æ–¹æºä¸‹è½½ 23.05.3"
            SDK_URL="https://downloads.immortalwrt.org/releases/23.05.3/targets/mediatek/filogic/"
          fi

          echo "æ­£åœ¨ä¸‹è½½ ImmortalWrt 23.05.3 MT7981 SDK..."
          echo "URL: $SDK_URL"
          
          # è·å– SDK æ–‡ä»¶å
          SDK_FILE=$(curl -fsSL "${SDK_URL}sha256sums" | grep -oE '(immortalwrt|openwrt)-sdk-[^ ]*Linux-x86_64\.tar\.xz' | head -n1)
          
          if [ -z "$SDK_FILE" ]; then
            echo "âŒ æ— æ³•æ‰¾åˆ° SDK æ–‡ä»¶ï¼Œå°è¯•å¤‡é€‰æ–¹æ¡ˆ..."
            # å°è¯•å…¶ä»–å¯èƒ½çš„æ–‡ä»¶åæ ¼å¼
            SDK_FILE=$(curl -fsSL "${SDK_URL}sha256sums" | grep -E 'sdk.*\.tar\.xz' | head -n1 | awk '{print $2}')
          fi

          if [ -z "$SDK_FILE" ]; then
            echo "âŒ é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ° SDK æ–‡ä»¶"
            echo "è¯·æ‰‹åŠ¨è®¿é—®ä»¥ä¸‹é“¾æ¥æ£€æŸ¥æ–‡ä»¶åˆ—è¡¨ï¼š"
            echo "$SDK_URL"
            exit 1
          fi
          
          echo "æ‰¾åˆ° SDK æ–‡ä»¶: $SDK_FILE"
          echo "ä¸‹è½½åœ°å€: ${SDK_URL}${SDK_FILE}"
          
          # ä¸‹è½½å¹¶éªŒè¯æ–‡ä»¶
          wget --progress=dot:giga "${SDK_URL}${SDK_FILE}" -O sdk.tar.xz
          
          if [ ! -s sdk.tar.xz ]; then
            echo "âŒ SDK ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
          
          echo "æ–‡ä»¶å¤§å°: $(du -h sdk.tar.xz | cut -f1)"
          
          # è§£å‹ SDK
          mkdir -p sdk
          tar -xf sdk.tar.xz -C sdk --strip-components=1
          
          if [ $? -ne 0 ]; then
            echo "âŒ SDK è§£å‹å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… SDK å‡†å¤‡å®Œæˆ"

      - name: Clean feeds to avoid recursive dependencies
        working-directory: sdk
        run: |
          # åˆ›å»ºç®€åŒ–çš„ feeds é…ç½®ï¼Œé¿å…å¤æ‚ä¾èµ–
          cat > feeds.conf.default << 'EOF'
          src-git packages https://github.com/immortalwrt/packages;openwrt-23.05
          src-git luci https://github.com/immortalwrt/luci;openwrt-23.05
          src-git passwall2 https://github.com/xiaorouji/openwrt-passwall2
          src-git pwpackages https://github.com/xiaorouji/openwrt-passwall-packages
          EOF

          echo "=== æ›´æ–°æœ€å°åŒ– feeds ==="
          ./scripts/feeds update packages luci passwall2 pwpackages

      - name: Install only necessary packages
        working-directory: sdk
        run: |
          echo "=== å®‰è£…æœ€å°ä¾èµ–é›† ==="
          # åªå®‰è£…å¿…è¦çš„åŒ…ï¼Œé¿å…é€’å½’ä¾èµ–
          ./scripts/feeds install libopenssl
          ./scripts/feeds install libpcre
          ./scripts/feeds install zlib
          ./scripts/feeds install libstdcpp
          ./scripts/feeds install golang
          ./scripts/feeds install luci-base
          ./scripts/feeds install luci-compat
          ./scripts/feeds install luci-app-passwall2

      - name: Create minimal configuration (avoid recursive deps)
        working-directory: sdk
        run: |
          # åˆ›å»ºæœ€å°åŒ–é…ç½®ï¼Œé¿å…é€’å½’ä¾èµ–
          cat > .config << 'EOF'
          # ======================
          # ç›®æ ‡æ¶æ„é…ç½® - MT7981
          # ======================
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y

          # ======================
          # å·¥å…·é“¾é…ç½®
          # ======================
          CONFIG_TOOLCHAIN=y

          # ======================
          # æ ¸å¿ƒåº“ä¾èµ– (æœ€å°é›†)
          # ======================
          CONFIG_PACKAGE_libc=y
          CONFIG_PACKAGE_libgcc=y
          CONFIG_PACKAGE_libstdcpp=y
          CONFIG_PACKAGE_libopenssl=y
          CONFIG_PACKAGE_libpcre=y
          CONFIG_PACKAGE_zlib=y
          CONFIG_PACKAGE_libpthread=y
          CONFIG_PACKAGE_librt=y

          # ======================
          # Golang ç¯å¢ƒ
          # ======================
          CONFIG_PACKAGE_golang=y

          # ======================
          # Luci åŸºç¡€ (æœ€å°é›†)
          # ======================
          CONFIG_PACKAGE_luci-base=y
          CONFIG_PACKAGE_luci-compat=y

          # ======================
          # å†…æ ¸æ¨¡å— (æœ€å°é›†)
          # ======================
          CONFIG_PACKAGE_kmod-nf-conntrack=y
          CONFIG_PACKAGE_kmod-nf-ipt=y
          CONFIG_PACKAGE_kmod-nf-nat=y
          CONFIG_PACKAGE_kmod-ipt-core=y
          CONFIG_PACKAGE_kmod-tun=y

          # ======================
          # ç½‘ç»œå·¥å…· (æœ€å°é›†)
          # ======================
          CONFIG_PACKAGE_iptables=y
          CONFIG_PACKAGE_iptables-mod-tproxy=y
          CONFIG_PACKAGE_ip-full=y

          # ======================
          # ç³»ç»Ÿå·¥å…· (æœ€å°é›†)
          # ======================
          CONFIG_PACKAGE_coreutils=y
          CONFIG_PACKAGE_ca-bundle=y
          CONFIG_PACKAGE_ca-certificates=y

          # ======================
          # Passwall2 ä¸»åŒ…
          # ======================
          CONFIG_PACKAGE_luci-app-passwall2=y

          # ======================
          # ç¼–è¯‘ä¼˜åŒ–
          # ======================
          CONFIG_CCACHE=y
          CONFIG_BUILD_LOG=y
          EOF

          # åº”ç”¨é…ç½®
          echo "=== åº”ç”¨æœ€å°é…ç½® ==="
          make defconfig
          
          echo "=== é…ç½®éªŒè¯ ==="
          echo "å¯ç”¨çš„åŒ…æ•°é‡: $(grep '^CONFIG_PACKAGE.*=y' .config | wc -l)"

      - name: Build toolchain first
        working-directory: sdk
        run: |
          set -e
          echo "=== é¦–å…ˆç¼–è¯‘å·¥å…·é“¾ ==="
          
          # å…ˆç¼–è¯‘å·¥å…·é“¾ï¼Œé¿å…ä¾èµ–é—®é¢˜
          make toolchain/compile -j$(nproc) V=sc
          make toolchain/install -j$(nproc) V=sc
          
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ"

      - name: Build core dependencies
        working-directory: sdk
        run: |
          set -e
          echo "=== ç¼–è¯‘æ ¸å¿ƒä¾èµ– ==="
          
          # æŒ‰é¡ºåºç¼–è¯‘æ ¸å¿ƒåº“
          make package/libopenssl/compile -j$(nproc) V=sc
          make package/libpcre/compile -j$(nproc) V=sc
          make package/zlib/compile -j$(nproc) V=sc
          make package/libstdcpp/compile -j$(nproc) V=sc
          
          echo "âœ… æ ¸å¿ƒåº“ç¼–è¯‘å®Œæˆ"

      - name: Build golang and luci base
        working-directory: sdk
        run: |
          set -e
          echo "=== ç¼–è¯‘ Golang å’Œ Luci åŸºç¡€ ==="
          
          make package/golang/compile -j$(nproc) V=sc
          make package/luci-base/compile -j$(nproc) V=sc
          make package/luci-compat/compile -j$(nproc) V=sc
          
          echo "âœ… Golang å’Œ Luci åŸºç¡€ç¼–è¯‘å®Œæˆ"

      - name: Build passwall2 directly
        working-directory: sdk
        run: |
          set -e
          mkdir -p $GITHUB_WORKSPACE/artifacts
          
          echo "=== ç›´æ¥ç¼–è¯‘ passwall2 ==="
          # ç›´æ¥ç¼–è¯‘ passwall2ï¼Œä¾èµ–åº”è¯¥å·²ç»å°±ç»ª
          if make package/luci-app-passwall2/compile -j$(nproc) V=s 2>&1 | tee $GITHUB_WORKSPACE/artifacts/passwall2_build.log; then
            echo "âœ… passwall2 ç¼–è¯‘æˆåŠŸ"
          else
            echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            if make package/luci-app-passwall2/compile -j1 V=s 2>&1 | tee $GITHUB_WORKSPACE/artifacts/passwall2_build_single.log; then
              echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæ”¶é›†é”™è¯¯ä¿¡æ¯"
              # ç»§ç»­æ‰§è¡Œä»¥æ”¶é›†åŒ…æ–‡ä»¶
            fi
          fi

      - name: Collect packages
        working-directory: sdk
        run: |
          set -e
          mkdir -p $GITHUB_WORKSPACE/artifacts/packages
          
          echo "=== æ”¶é›†ç”Ÿæˆçš„è½¯ä»¶åŒ… ==="
          
          # æŸ¥æ‰¾æ‰€æœ‰ IPK æ–‡ä»¶
          find bin -name "*.ipk" -type f | while read file; do
            filename=$(basename "$file")
            size=$(du -h "$file" | cut -f1)
            echo "ğŸ“¦ æ‰¾åˆ°: $filename ($size)"
            cp "$file" $GITHUB_WORKSPACE/artifacts/packages/
          done
          
          echo "=== åŒ…æ–‡ä»¶ç»Ÿè®¡ ==="
          ipk_count=$(find $GITHUB_WORKSPACE/artifacts/packages -name "*.ipk" | wc -l)
          echo "ç”Ÿæˆçš„ IPK åŒ…æ•°é‡: $ipk_count"
          
          if [ "$ipk_count" -gt 0 ]; then
            echo "PACKAGES_BUILT=true" >> $GITHUB_ENV
            echo "âœ… æˆåŠŸç”Ÿæˆè½¯ä»¶åŒ…"
          else
            echo "âš ï¸ æ²¡æœ‰ç”Ÿæˆè½¯ä»¶åŒ…"
          fi

      - name: Upload packages
        if: env.PACKAGES_BUILT == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: passwall2-packages-mt7981-fixed
          path: artifacts/packages/
          retention-days: 30

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-fixed
          path: artifacts/
          retention-days: 7

      - name: Final status
        run: |
          if [ "$PACKAGES_BUILT" = "true" ]; then
            echo "ğŸ‰ ç¼–è¯‘æˆåŠŸï¼è½¯ä»¶åŒ…å·²ç”Ÿæˆ"
          else
            echo "âš ï¸ ç¼–è¯‘è¿‡ç¨‹å®Œæˆï¼Œä½†æœªç”Ÿæˆè½¯ä»¶åŒ…"
            echo "è¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶äº†è§£è¯¦ç»†é”™è¯¯"
          fi
