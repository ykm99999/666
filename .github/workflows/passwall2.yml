name: Build passwall2 for SL3000 (ImmortalWrt 24.10 MT7981)

on:
  workflow_dispatch:
    inputs:
      immortalwrt_version:
        description: 'ImmortalWrt Version'
        required: true
        default: '24.10'
        type: choice
        options:
          - '24.10'
          - '23.05'

env:
  TZ: Asia/Shanghai
  TERM: xterm

jobs:
  build-packages:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex g++ gawk gettext git libncurses5-dev \
            libssl-dev python3-dev python3-full python3-pip python3-setuptools \
            rsync unzip zlib1g-dev file wget curl ccache cmake ninja-build \
            libelf-dev patchelf chrpath gawk texinfo diffutils

      - name: Download ImmortalWrt SDK for MT7981
        run: |
          IMMORTALWRT_VERSION="${{ inputs.immortalwrt_version || '24.10' }}"
          
          # ä½¿ç”¨ ImmortalWrt çš„ SDK
          if [ "$IMMORTALWRT_VERSION" = "24.10" ]; then
            SDK_URL="https://downloads.immortalwrt.org/releases/24.10-SNAPSHOT/targets/mediatek/filogic/"
          else
            SDK_URL="https://downloads.immortalwrt.org/releases/23.05-SNAPSHOT/targets/mediatek/filogic/"
          fi
          
          echo "ä¸‹è½½ ImmortalWrt MT7981 SDKï¼Œç‰ˆæœ¬: ${IMMORTALWRT_VERSION}"
          echo "SDK URL: ${SDK_URL}"
          
          # è·å– SDK æ–‡ä»¶å
          SDK_FILE=$(curl -fsSL "${SDK_URL}sha256sums" | grep -oE 'immortalwrt-sdk-[^ ]*Linux-x86_64\.tar\.xz' | head -n1)
          
          if [ -z "$SDK_FILE" ]; then
            echo "âŒ æ— æ³•æ‰¾åˆ° ImmortalWrt SDK æ–‡ä»¶ï¼Œå°è¯• openwrt-sdk"
            SDK_FILE=$(curl -fsSL "${SDK_URL}sha256sums" | grep -oE 'openwrt-sdk-[^ ]*Linux-x86_64\.tar\.xz' | head -n1)
          fi
          
          if [ -z "$SDK_FILE" ]; then
            echo "âŒ ä»ç„¶æ— æ³•æ‰¾åˆ° SDK æ–‡ä»¶"
            exit 1
          fi
          
          echo "ä¸‹è½½ SDK: ${SDK_FILE}"
          wget --progress=dot:giga "${SDK_URL}${SDK_FILE}" -O sdk.tar.xz
          mkdir -p sdk
          tar -xf sdk.tar.xz -C sdk --strip-components=1
          echo "IMMORTALWRT_VERSION=${IMMORTALWRT_VERSION}" >> $GITHUB_ENV

      - name: Setup feeds for ImmortalWrt
        working-directory: sdk
        run: |
          # åˆ›å»º feeds é…ç½® - ä½¿ç”¨ ImmortalWrt çš„æº
          cat > feeds.conf.default << 'EOF'
          src-git packages https://github.com/immortalwrt/packages;openwrt-24.10
          src-git luci https://github.com/immortalwrt/luci;openwrt-24.10
          src-git routing https://github.com/openwrt/routing;openwrt-24.10
          src-git passwall2 https://github.com/xiaorouji/openwrt-passwall2
          src-git pwpackages https://github.com/xiaorouji/openwrt-passwall-packages
          EOF

          echo "=== æ›´æ–° feeds ==="
          ./scripts/feeds update -a
          
          echo "=== å®‰è£…åŸºç¡€åŒ… ==="
          ./scripts/feeds install -a -p packages
          ./scripts/feeds install -a -p luci
          
          echo "=== å®‰è£… passwall2 ç›¸å…³åŒ… ==="
          ./scripts/feeds install -a -p passwall2
          ./scripts/feeds install -a -p pwpackages
          
          # æ˜¾å¼å®‰è£…å…³é”®åŒ…
          ./scripts/feeds install luci-app-passwall2
          ./scripts/feeds install golang
          ./scripts/feeds install coreutils-nohup

      - name: Create MT7981 package configuration
        working-directory: sdk
        run: |
          # åˆ›å»ºé’ˆå¯¹ MT7981 çš„é…ç½®
          cat > .config << 'EOF'
          # ç›®æ ‡æ¶æ„é…ç½® - MT7981
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y
          
          # å·¥å…·é“¾é…ç½®
          CONFIG_TOOLCHAIN=y
          CONFIG_PACKAGE_libc=y
          CONFIG_PACKAGE_libgcc=y
          CONFIG_PACKAGE_libstdcpp=y
          
          # Golang ç¯å¢ƒ
          CONFIG_PACKAGE_golang=y
          CONFIG_PACKAGE_golang-src=y
          
          # æ ¸å¿ƒåº“ä¾èµ–
          CONFIG_PACKAGE_libopenssl=y
          CONFIG_PACKAGE_libpcre=y
          CONFIG_PACKAGE_zlib=y
          CONFIG_PACKAGE_libpthread=y
          CONFIG_PACKAGE_librt=y
          CONFIG_PACKAGE_libatomic=y
          
          # Luci åŸºç¡€
          CONFIG_PACKAGE_luci-base=y
          CONFIG_PACKAGE_luci-compat=y
          CONFIG_PACKAGE_luci-lib-ipkg=y
          CONFIG_PACKAGE_luci-theme-bootstrap=y
          
          # å†…æ ¸æ¨¡å—ï¼ˆç½‘ç»œç›¸å…³ï¼‰- MT7981 ç‰¹å®š
          CONFIG_PACKAGE_kmod-nf-conntrack=y
          CONFIG_PACKAGE_kmod-nf-ipt=y
          CONFIG_PACKAGE_kmod-nf-nat=y
          CONFIG_PACKAGE_kmod-ipt-core=y
          CONFIG_PACKAGE_kmod-tun=y
          CONFIG_PACKAGE_kmod-crypto-core=y
          CONFIG_PACKAGE_kmod-crypto-aead=y
          CONFIG_PACKAGE_kmod-ipt-tproxy=y
          
          # ç½‘ç»œå·¥å…·
          CONFIG_PACKAGE_iptables=y
          CONFIG_PACKAGE_iptables-mod-tproxy=y
          CONFIG_PACKAGE_iptables-mod-extra=y
          CONFIG_PACKAGE_ip-full=y
          CONFIG_PACKAGE_resolveip=y
          
          # ç³»ç»Ÿå·¥å…·
          CONFIG_PACKAGE_coreutils=y
          CONFIG_PACKAGE_coreutils-nohup=y
          CONFIG_PACKAGE_bash=y
          CONFIG_PACKAGE_ca-bundle=y
          CONFIG_PACKAGE_ca-certificates=y
          
          # Passwall2 ä¸»åŒ…
          CONFIG_PACKAGE_luci-app-passwall2=y
          CONFIG_PACKAGE_luci-i18n-passwall2-zh-cn=y
          
          # ç¼–è¯‘ä¼˜åŒ–
          CONFIG_CCACHE=y
          CONFIG_BUILD_LOG=y
          EOF

          # åº”ç”¨é…ç½®
          echo "=== åº”ç”¨é»˜è®¤é…ç½® ==="
          make defconfig
          
          echo "=== é…ç½®æ‘˜è¦ ==="
          echo "ç›®æ ‡æ¶æ„: mediatek/filogic (MT7981)"
          echo "å¯ç”¨çš„åŒ…æ•°é‡: $(grep '^CONFIG_PACKAGE.*=y' .config | wc -l)"

      - name: Build dependencies
        working-directory: sdk
        run: |
          set -e
          echo "=== ç¼–è¯‘å·¥å…·é“¾å’Œæ ¸å¿ƒä¾èµ– ==="
          
          # ç¼–è¯‘å·¥å…·é“¾
          make toolchain/install -j$(nproc) V=sc
          
          # ç¼–è¯‘æ ¸å¿ƒåº“
          make package/libopenssl/compile package/libpcre/compile package/zlib/compile -j$(nproc) V=sc
          
          # ç¼–è¯‘ Golang
          make package/golang/compile -j$(nproc) V=sc
          
          # ç¼–è¯‘ Luci åŸºç¡€
          make package/luci-base/compile package/luci-compat/compile -j$(nproc) V=sc

      - name: Build passwall2 package
        working-directory: sdk
        run: |
          set -e
          mkdir -p $GITHUB_WORKSPACE/artifacts
          
          echo "=== ç¼–è¯‘ passwall2 ä¸»åŒ… ==="
          # ç¼–è¯‘ passwall2
          make package/luci-app-passwall2/compile -j$(nproc) V=s 2>&1 | tee $GITHUB_WORKSPACE/artifacts/passwall2_build.log || {
            echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            make package/luci-app-passwall2/compile -j1 V=s 2>&1 | tee $GITHUB_WORKSPACE/artifacts/passwall2_build_single.log
          }

      - name: Collect and verify packages
        working-directory: sdk
        run: |
          set -e
          mkdir -p $GITHUB_WORKSPACE/artifacts/packages
          
          echo "=== æ”¶é›†ç¼–è¯‘å¥½çš„è½¯ä»¶åŒ… ==="
          
          # æŸ¥æ‰¾æ‰€æœ‰ IPK æ–‡ä»¶
          find bin -name "*.ipk" -type f | while read file; do
            filename=$(basename "$file")
            echo "ğŸ“¦ æ‰¾åˆ°: $filename"
            cp "$file" $GITHUB_WORKSPACE/artifacts/packages/
          done
          
          echo "=== åŒ…æ–‡ä»¶ç»Ÿè®¡ ==="
          ipk_count=$(find $GITHUB_WORKSPACE/artifacts/packages -name "*.ipk" | wc -l)
          echo "ç”Ÿæˆçš„ IPK åŒ…æ•°é‡: $ipk_count"
          
          if [ "$ipk_count" -eq 0 ]; then
            echo "âŒ æ²¡æœ‰ç”Ÿæˆä»»ä½•è½¯ä»¶åŒ…"
            exit 1
          fi
          
          # åˆ—å‡ºæ–‡ä»¶è¯¦æƒ…
          ls -la $GITHUB_WORKSPACE/artifacts/packages/
          echo "PACKAGES_BUILT=true" >> $GITHUB_ENV

      - name: Upload packages artifact
        if: env.PACKAGES_BUILT == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: passwall2-packages-mt7981-immortalwrt
          path: artifacts/packages/
          retention-days: 30

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-mt7981
          path: artifacts/
          retention-days: 7

      - name: Build success notification
        if: success() && env.PACKAGES_BUILT == 'true'
        run: |
          echo "ğŸ‰ passwall2 è½¯ä»¶åŒ…ç¼–è¯‘æˆåŠŸï¼"
          echo "æ¶æ„: ImmortalWrt 24.10 + MT7981"
          echo "ç”Ÿæˆçš„åŒ…å·²ä¸Šä¼ åˆ° Artifacts"

      - name: Build failure notification
        if: failure()
        run: |
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          echo "è¯¦ç»†æ—¥å¿—å·²ä¸Šä¼ åˆ° Artifacts"
