name: Build OpenWrt for SL-3000 with WiFi + PassWall2

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git wget curl unzip \
          libncurses5-dev libncursesw5-dev zlib1g-dev gawk flex gettext \
          libssl-dev python3 python3-distutils rsync

    - name: Clone OpenWrt source (stable branch)
      run: |
        git clone https://github.com/padavanonly/immortalwrt-mt798x-24.10 -b 2410 openwrt

    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Generate .config
      run: |
        cd openwrt
        cat > .config <<'EOF'
        CONFIG_TARGET_mediatek=y
        CONFIG_TARGET_mediatek_filogic=y
        CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000=y

        # Wi-Fi 驱动与工具
        CONFIG_PACKAGE_kmod-mt76=y
        CONFIG_PACKAGE_kmod-mt76-core=y
        CONFIG_PACKAGE_kmod-mt76-connac=y
        CONFIG_PACKAGE_kmod-mac80211=y
        CONFIG_PACKAGE_kmod-cfg80211=y
        CONFIG_PACKAGE_wireless-tools=y
        CONFIG_PACKAGE_wpad-basic-mbedtls=y

        # LuCI 界面
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-app-firewall=y
        CONFIG_PACKAGE_luci-app-uhttpd=y

        # PassWall2 套件
        CONFIG_PACKAGE_luci-app-passwall2=y
        CONFIG_PACKAGE_xray-core=y
        CONFIG_PACKAGE_trojan=y
        CONFIG_PACKAGE_shadowsocks-libev=y
        CONFIG_PACKAGE_naiveproxy=y
        CONFIG_PACKAGE_hysteria=y
        CONFIG_PACKAGE_sing-box=y
        EOF

    - name: Build toolchain
      run: |
        cd openwrt
        make defconfig
        make toolchain/install V=s

    - name: Build firmware
      run: |
        cd openwrt
        make -j$(nproc) V=s

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-firmware
        path: openwrt/bin/targets/mediatek/filogic/

    - name: Upload packages
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-packages
        path: openwrt/bin/packages/aarch64_cortex-a53/
