name: Build passwall2 Packages Only (mt7621)

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt Version'
        required: true
        default: '23.05.3'
        type: choice
        options:
          - '23.05.3'
          - '23.05.2'

env:
  TZ: Asia/Shanghai
  TERM: xterm

jobs:
  build-packages:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install essential build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gawk unzip wget git libncurses5-dev \
            zlib1g-dev libssl-dev python3 python3-distutils rsync file

      - name: Download OpenWrt SDK
        run: |
          OPENWRT_VERSION="${{ inputs.openwrt_version || '23.05.3' }}"
          SDK_URL="https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/targets/ramips/mt7621/"
          SDK_FILE=$(curl -fsSL ${SDK_URL}sha256sums | grep -oE 'openwrt-sdk-[^ ]*Linux-x86_64\.tar\.xz' | head -n1)
          echo "下载 SDK: ${SDK_FILE}"
          wget "${SDK_URL}${SDK_FILE}" -O sdk.tar.xz
          mkdir sdk && tar -xf sdk.tar.xz -C sdk --strip-components=1

      - name: Setup feeds for passwall2
        working-directory: sdk
        run: |
          # 简化 feeds 配置
          echo "src-git packages https://github.com/openwrt/packages;openwrt-23.05" > feeds.conf.default
          echo "src-git luci https://github.com/openwrt/luci;openwrt-23.05" >> feeds.conf.default
          echo "src-git passwall2 https://github.com/xiaorouji/openwrt-passwall2" >> feeds.conf.default
          echo "src-git pwpackages https://github.com/xiaorouji/openwrt-passwall-packages" >> feeds.conf.default
          
          # 更新和安装必要的 feeds
          ./scripts/feeds update packages luci passwall2 pwpackages
          ./scripts/feeds install -a

      - name: Create minimal package build configuration
        working-directory: sdk
        run: |
          # 使用上面提供的简化配置
          cat > .config << 'EOF'
          CONFIG_TARGET_ramips=y
          CONFIG_TARGET_ramips_mt7621=y
          CONFIG_TOOLCHAIN=y
          CONFIG_PACKAGE_libc=y
          CONFIG_PACKAGE_libgcc=y
          CONFIG_PACKAGE_libstdcpp=y
          CONFIG_PACKAGE_golang=y
          CONFIG_PACKAGE_golang-src=y
          CONFIG_PACKAGE_libopenssl=y
          CONFIG_PACKAGE_libpcre=y
          CONFIG_PACKAGE_zlib=y
          CONFIG_PACKAGE_luci-base=y
          CONFIG_PACKAGE_luci-compat=y
          CONFIG_PACKAGE_luci-app-passwall2=y
          CONFIG_CCACHE=y
          EOF
          
          make defconfig

      - name: Build passwall2 package
        working-directory: sdk
        run: |
          set -e
          mkdir -p $GITHUB_WORKSPACE/artifacts
          
          echo "=== 开始编译 passwall2 ==="
          # 直接编译 passwall2，让系统自动处理依赖
          make package/luci-app-passwall2/compile V=s -j2 2>&1 | tee $GITHUB_WORKSPACE/artifacts/build.log

      - name: Collect built packages
        working-directory: sdk
        run: |
          echo "=== 收集编译好的包 ==="
          mkdir -p $GITHUB_WORKSPACE/artifacts/packages
          
          # 查找所有 ipk 文件
          find bin -name "*.ipk" -type f | head -20 | while read file; do
            echo "复制: $(basename $file)"
            cp "$file" $GITHUB_WORKSPACE/artifacts/packages/
          done
          
          echo "=== 包列表 ==="
          ls -la $GITHUB_WORKSPACE/artifacts/packages/ || echo "没有找到包"

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: passwall2-packages
          path: artifacts/packages/
          retention-days: 30

      - name: Upload build log
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: artifacts/build.log
