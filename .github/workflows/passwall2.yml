name: Build Passwall2 for ImmortalWrt 23.05.3 (MT7981)

on:
  workflow_dispatch:
    inputs:
      use_mirror:
        description: 'ä½¿ç”¨ä¸­ç§‘å¤§é•œåƒ'
        required: false
        default: true
        type: boolean

env:
  TZ: Asia/Shanghai
  TERM: xterm

jobs:
  build-packages:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex g++ gawk gettext git libncurses5-dev \
            libssl-dev python3-dev python3-full python3-pip python3-setuptools \
            rsync unzip zlib1g-dev file wget curl ccache cmake ninja-build \
            libelf-dev patchelf chrpath gawk texinfo diffutils gperf

      - name: Download ImmortalWrt SDK for MT7981
        run: |
          # ä½¿ç”¨å®˜æ–¹ç¨³å®šç‰ˆ 23.05.3
          if [ "${{ inputs.use_mirror }}" = "true" ]; then
            echo "ä½¿ç”¨ä¸­ç§‘å¤§é•œåƒä¸‹è½½ 23.05.3"
            SDK_URL="https://mirrors.ustc.edu.cn/immortalwrt/releases/23.05.3/targets/mediatek/filogic/"
          else
            echo "ä½¿ç”¨å®˜æ–¹æºä¸‹è½½ 23.05.3"
            SDK_URL="https://downloads.immortalwrt.org/releases/23.05.3/targets/mediatek/filogic/"
          fi

          echo "æ­£åœ¨ä¸‹è½½ ImmortalWrt 23.05.3 MT7981 SDK..."
          echo "URL: $SDK_URL"
          
          # è·å– SDK æ–‡ä»¶å
          SDK_FILE=$(curl -fsSL "${SDK_URL}sha256sums" | grep -oE '(immortalwrt|openwrt)-sdk-[^ ]*Linux-x86_64\.tar\.xz' | head -n1)
          
          if [ -z "$SDK_FILE" ]; then
            echo "âŒ æ— æ³•æ‰¾åˆ° SDK æ–‡ä»¶ï¼Œå°è¯•å¤‡é€‰æ–¹æ¡ˆ..."
            # å°è¯•å…¶ä»–å¯èƒ½çš„æ–‡ä»¶åæ ¼å¼
            SDK_FILE=$(curl -fsSL "${SDK_URL}sha256sums" | grep -E 'sdk.*\.tar\.xz' | head -n1 | awk '{print $2}')
          fi

          if [ -z "$SDK_FILE" ]; then
            echo "âŒ é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ° SDK æ–‡ä»¶"
            echo "è¯·æ‰‹åŠ¨è®¿é—®ä»¥ä¸‹é“¾æ¥æ£€æŸ¥æ–‡ä»¶åˆ—è¡¨ï¼š"
            echo "$SDK_URL"
            exit 1
          fi
          
          echo "æ‰¾åˆ° SDK æ–‡ä»¶: $SDK_FILE"
          echo "ä¸‹è½½åœ°å€: ${SDK_URL}${SDK_FILE}"
          
          # ä¸‹è½½å¹¶éªŒè¯æ–‡ä»¶
          wget --progress=dot:giga "${SDK_URL}${SDK_FILE}" -O sdk.tar.xz
          
          if [ ! -s sdk.tar.xz ]; then
            echo "âŒ SDK ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
          
          echo "æ–‡ä»¶å¤§å°: $(du -h sdk.tar.xz | cut -f1)"
          
          # è§£å‹ SDK
          mkdir -p sdk
          tar -xf sdk.tar.xz -C sdk --strip-components=1
          
          if [ $? -ne 0 ]; then
            echo "âŒ SDK è§£å‹å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… SDK å‡†å¤‡å®Œæˆ"

      - name: Setup feeds for ImmortalWrt 23.05
        working-directory: sdk
        run: |
          # åˆ›å»ºé’ˆå¯¹ 23.05 çš„ feeds é…ç½®
          cat > feeds.conf.default << 'EOF'
          src-git packages https://github.com/immortalwrt/packages;openwrt-23.05
          src-git luci https://github.com/immortalwrt/luci;openwrt-23.05
          src-git routing https://github.com/openwrt/routing;openwrt-23.05
          src-git passwall2 https://github.com/xiaorouji/openwrt-passwall2
          src-git pwpackages https://github.com/xiaorouji/openwrt-passwall-packages
          EOF

          echo "=== å¼€å§‹æ›´æ–° feeds ==="
          ./scripts/feeds update -a
          
          echo "=== å®‰è£…åŸºç¡€è½¯ä»¶åŒ… ==="
          ./scripts/feeds install -a -p packages
          ./scripts/feeds install -a -p luci
          
          echo "=== å®‰è£… Passwall2 ç›¸å…³åŒ… ==="
          ./scripts/feeds install -a -p passwall2
          ./scripts/feeds install -a -p pwpackages
          
          # æ˜¾å¼å®‰è£…å…³é”®åŒ…
          echo "=== å®‰è£…æ ¸å¿ƒä¾èµ–åŒ… ==="
          ./scripts/feeds install luci-app-passwall2
          ./scripts/feeds install golang
          ./scripts/feeds install coreutils-nohup
          ./scripts/feeds install libopenssl
          ./scripts/feeds install libpcre
          ./scripts/feeds install libstdcpp

      - name: Create MT7981 package configuration
        working-directory: sdk
        run: |
          # åˆ›å»ºé’ˆå¯¹ MT7981 çš„å®Œæ•´é…ç½®
          cat > .config << 'EOF'
          # ======================
          # ç›®æ ‡æ¶æ„é…ç½® - MT7981
          # ======================
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y

          # ======================
          # å·¥å…·é“¾é…ç½®
          # ======================
          CONFIG_TOOLCHAIN=y
          CONFIG_PACKAGE_libc=y
          CONFIG_PACKAGE_libgcc=y
          CONFIG_PACKAGE_libstdcpp=y

          # ======================
          # Golang ç¯å¢ƒ
          # ======================
          CONFIG_PACKAGE_golang=y
          CONFIG_PACKAGE_golang-src=y

          # ======================
          # æ ¸å¿ƒåº“ä¾èµ–
          # ======================
          CONFIG_PACKAGE_libopenssl=y
          CONFIG_PACKAGE_libpcre=y
          CONFIG_PACKAGE_zlib=y
          CONFIG_PACKAGE_libpthread=y
          CONFIG_PACKAGE_librt=y
          CONFIG_PACKAGE_libatomic=y
          CONFIG_PACKAGE_libjson-c=y

          # ======================
          # Luci åŸºç¡€
          # ======================
          CONFIG_PACKAGE_luci-base=y
          CONFIG_PACKAGE_luci-compat=y
          CONFIG_PACKAGE_luci-lib-ipkg=y
          CONFIG_PACKAGE_luci-theme-bootstrap=y
          CONFIG_PACKAGE_luci-proto-ipv6=y

          # ======================
          # å†…æ ¸æ¨¡å—ï¼ˆç½‘ç»œç›¸å…³ï¼‰
          # ======================
          CONFIG_PACKAGE_kmod-nf-conntrack=y
          CONFIG_PACKAGE_kmod-nf-conntrack-netlink=y
          CONFIG_PACKAGE_kmod-nf-ipt=y
          CONFIG_PACKAGE_kmod-nf-nat=y
          CONFIG_PACKAGE_kmod-nf-reject=y
          CONFIG_PACKAGE_kmod-nfnetlink=y
          CONFIG_PACKAGE_kmod-ipt-core=y
          CONFIG_PACKAGE_kmod-ipt-extra=y
          CONFIG_PACKAGE_kmod-tun=y
          CONFIG_PACKAGE_kmod-crypto-core=y
          CONFIG_PACKAGE_kmod-crypto-aead=y
          CONFIG_PACKAGE_kmod-ipt-tproxy=y

          # ======================
          # ç½‘ç»œå·¥å…·
          # ======================
          CONFIG_PACKAGE_iptables=y
          CONFIG_PACKAGE_iptables-mod-tproxy=y
          CONFIG_PACKAGE_iptables-mod-extra=y
          CONFIG_PACKAGE_ip-full=y
          CONFIG_PACKAGE_ipset=y
          CONFIG_PACKAGE_resolveip=y

          # ======================
          # ç³»ç»Ÿå·¥å…·
          # ======================
          CONFIG_PACKAGE_coreutils=y
          CONFIG_PACKAGE_coreutils-nohup=y
          CONFIG_PACKAGE_bash=y
          CONFIG_PACKAGE_ca-bundle=y
          CONFIG_PACKAGE_ca-certificates=y

          # ======================
          # Passwall2 ä¸»åŒ…
          # ======================
          CONFIG_PACKAGE_luci-app-passwall2=y
          CONFIG_PACKAGE_luci-i18n-passwall2-zh-cn=y

          # ======================
          # ç¼–è¯‘ä¼˜åŒ–
          # ======================
          CONFIG_CCACHE=y
          CONFIG_BUILD_LOG=y
          EOF

          # åº”ç”¨é…ç½®
          echo "=== åº”ç”¨é»˜è®¤é…ç½® ==="
          make defconfig
          
          echo "=== é…ç½®æ‘˜è¦ ==="
          echo "ç›®æ ‡æ¶æ„: mediatek/filogic (MT7981)"
          echo "å¯ç”¨çš„åŒ…æ•°é‡: $(grep '^CONFIG_PACKAGE.*=y' .config | wc -l)"

      - name: Build dependencies first
        working-directory: sdk
        run: |
          set -e
          echo "=== ç¼–è¯‘å·¥å…·é“¾å’Œæ ¸å¿ƒä¾èµ– ==="
          
          # ç¼–è¯‘å·¥å…·é“¾
          make toolchain/install -j$(nproc) V=sc
          
          echo "=== ç¼–è¯‘æ ¸å¿ƒåº“ ==="
          make package/libopenssl/compile package/libpcre/compile package/zlib/compile -j$(nproc) V=sc
          
          echo "=== ç¼–è¯‘ Golang ==="
          make package/golang/compile -j$(nproc) V=sc
          
          echo "=== ç¼–è¯‘ Luci åŸºç¡€ ==="
          make package/luci-base/compile package/luci-compat/compile -j$(nproc) V=sc

      - name: Build passwall2 package
        working-directory: sdk
        run: |
          set -e
          mkdir -p $GITHUB_WORKSPACE/artifacts
          
          echo "=== ç¼–è¯‘ passwall2 ä¸»åŒ… ==="
          # é¦–å…ˆå°è¯•å¹¶è¡Œç¼–è¯‘
          if make package/luci-app-passwall2/compile -j$(nproc) V=s 2>&1 | tee $GITHUB_WORKSPACE/artifacts/passwall2_build.log; then
            echo "âœ… å¹¶è¡Œç¼–è¯‘æˆåŠŸ"
          else
            echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            if make package/luci-app-passwall2/compile -j1 V=s 2>&1 | tee $GITHUB_WORKSPACE/artifacts/passwall2_build_single.log; then
              echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
              # ä¸ç«‹å³é€€å‡ºï¼Œç»§ç»­æ”¶é›†æ—¥å¿—
            fi
          fi

      - name: Collect and verify packages
        working-directory: sdk
        run: |
          set -e
          mkdir -p $GITHUB_WORKSPACE/artifacts/packages
          
          echo "=== æ”¶é›†ç¼–è¯‘å¥½çš„è½¯ä»¶åŒ… ==="
          
          # æŸ¥æ‰¾æ‰€æœ‰ IPK æ–‡ä»¶
          find bin -name "*.ipk" -type f | while read file; do
            filename=$(basename "$file")
            size=$(du -h "$file" | cut -f1)
            echo "ğŸ“¦ æ‰¾åˆ°: $filename ($size)"
            cp "$file" $GITHUB_WORKSPACE/artifacts/packages/
          done
          
          echo "=== åŒ…æ–‡ä»¶ç»Ÿè®¡ ==="
          ipk_count=$(find $GITHUB_WORKSPACE/artifacts/packages -name "*.ipk" | wc -l)
          echo "ç”Ÿæˆçš„ IPK åŒ…æ•°é‡: $ipk_count"
          
          # åˆ—å‡º passwall2 ç›¸å…³åŒ…
          echo "=== Passwall2 ç›¸å…³åŒ… ==="
          find $GITHUB_WORKSPACE/artifacts/packages -name "*passwall*" -o -name "*pw2*" | while read file; do
            echo "ğŸ”¸ $(basename "$file")"
          done
          
          if [ "$ipk_count" -eq 0 ]; then
            echo "âš ï¸ æ²¡æœ‰ç”Ÿæˆä»»ä½•è½¯ä»¶åŒ…ï¼Œä½†ç»§ç»­æ‰§è¡Œä»¥æ”¶é›†æ—¥å¿—"
          else
            echo "PACKAGES_BUILT=true" >> $GITHUB_ENV
          fi
          
          # æ˜¾ç¤ºæ–‡ä»¶è¯¦æƒ…
          echo "=== åŒ…åˆ—è¡¨è¯¦æƒ… ==="
          ls -la $GITHUB_WORKSPACE/artifacts/packages/ || echo "æ²¡æœ‰åŒ…æ–‡ä»¶"

      - name: Upload packages artifact
        if: env.PACKAGES_BUILT == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: passwall2-packages-mt7981-23.05.3
          path: artifacts/packages/
          retention-days: 30
          overwrite: true

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-mt7981-23.05.3
          path: artifacts/
          retention-days: 7
          overwrite: true

      - name: Build success notification
        if: success() && env.PACKAGES_BUILT == 'true'
        run: |
          echo "ğŸ‰ Passwall2 è½¯ä»¶åŒ…ç¼–è¯‘æˆåŠŸï¼"
          echo "========================================"
          echo "æ¶æ„: ImmortalWrt 23.05.3 + MT7981"
          echo "è®¾å¤‡: å¸ç»œ SL-3000"
          echo "ç”Ÿæˆçš„åŒ…å·²ä¸Šä¼ åˆ° Artifacts"
          echo "========================================"

      - name: Build completion notification
        if: always()
        run: |
          if [ "$PACKAGES_BUILT" = "true" ]; then
            echo "âœ… ç¼–è¯‘æµç¨‹å®Œæˆ - è½¯ä»¶åŒ…å·²ç”Ÿæˆ"
          else
            echo "âš ï¸ ç¼–è¯‘æµç¨‹å®Œæˆ - ä½†æœªç”Ÿæˆè½¯ä»¶åŒ…ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
