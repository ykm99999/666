name: Build OpenWrt SL-3000

on:
  workflow_dispatch:   # 仅手动触发，不会自动运行

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git libncurses5-dev gawk gettext unzip file libssl-dev wget python3 ccache

    - name: Get OpenWrt source
      run: |
        git clone https://github.com/openwrt/openwrt.git
        cd openwrt
        git checkout v24.10.4
        # 删除 telephony 和 routing feed
        sed -i '/telephony/d' feeds.conf.default
        sed -i '/routing/d' feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Remove unsupported packages
      run: |
        cd openwrt
        rm -rf feeds/luci/applications/luci-app-bmx7*
        rm -rf feeds/luci/applications/luci-app-olsr*
        rm -rf feeds/luci/applications/luci-app-babeld*
        rm -rf feeds/luci/proto/luci-proto-batman-adv*
        rm -rf feeds/packages/bmx7*
        rm -rf feeds/packages/prometheus-node-exporter-lua

    - name: Copy custom config
      run: |
        cp .config openwrt/.config

    - name: Cache downloads
      uses: actions/cache@v4
      with:
        path: openwrt/dl
        key: ${{ runner.os }}-openwrt-dl-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-openwrt-dl-

    - name: Clean before build
      run: |
        cd openwrt
        make clean

    - name: Build
      run: |
        cd openwrt
        make defconfig
        make -j1 V=s   # 单线程编译，详细日志

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: openwrt/bin/targets

    - name: Cleanup
      run: |
        rm -rf openwrt/build_dir
        rm -rf openwrt/staging_dir
